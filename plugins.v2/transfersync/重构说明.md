# TransferSync 插件重构说明

## 重构目标
参考 p115strmhelper 项目的模块化设计，对 transfersync 项目进行重构，解决以下问题：
1. `__init__.py` 文件过于庞大的问题
2. 同步路径逻辑不正确的问题
3. 缺乏模块化设计的问题

## 重构内容

### 1. 新增核心模块目录 `core/`

#### `core/config_manager.py`
- **功能**: 配置管理器，负责解析和验证插件配置
- **特点**:
  - 支持多路径同步配置解析 (`源路径1->目标路径1,源路径2->目标路径2`)
  - 支持两种路径分隔符：`->` 和 `::`
  - 集成配置验证功能
  - 缓存配置验证结果

#### `core/event_manager.py`
- **功能**: 事件管理器，负责注册和处理各种事件
- **特点**:
  - 统一的事件处理逻辑
  - 支持延迟执行和立即执行
  - 事件统计功能
  - 路径匹配和事件过滤

#### `core/service_manager.py`
- **功能**: 服务管理器，管理外部服务依赖
- **特点**:
  - 延迟初始化外部服务
  - 本地缓存管理
  - 性能指标监控
  - 健康状态检查

### 2. 修复同步路径逻辑

#### 原有问题
- 只支持单一的 `_sync_root_path` 和 `_sync_target_path`
- 无法处理多个不同的同步路径配置

#### 修复后的功能
- 支持多组同步路径配置：`_sync_paths` 列表
- 每个配置包含 `source` 和 `target` 字段
- 智能匹配触发路径到对应的同步配置
- 支持相对路径计算，保持目录结构

### 3. 重构主文件 `__init__.py`

#### 原文件问题
- 超过 300 行代码，功能过于集中
- 配置解析逻辑复杂
- 事件处理分散

#### 重构后的改进
- 主文件精简到约 200 行
- 功能模块化，职责分离
- 使用管理器模式组织代码
- 延迟初始化，提高性能

### 4. 改进同步操作 `sync_operations.py`

#### 新增功能
- `execute_sync()` 方法：支持基于配置的同步操作
- 智能路径匹配：自动找到合适的同步配置
- 相对路径计算：保持目录结构的一致性
- 向后兼容：保留原有的 `sync_directory()` 方法

## 配置格式变更

### 新的路径配置格式
```
# 支持多种格式：
源路径1->目标路径1,源路径2->目标路径2
# 或者
源路径1::目标路径1,源路径2::目标路径2
```

### 配置示例
```
/media/downloads->/backup/downloads,/media/movies->/backup/movies
```

## 架构优势

### 1. 模块化设计
- 每个模块职责单一
- 易于维护和扩展
- 代码复用性强

### 2. 可扩展性
- 新增功能时只需修改对应模块
- 支持插件式的功能扩展

### 3. 可维护性
- 代码结构清晰
- 错误定位容易
- 单元测试友好

### 4. 性能优化
- 延迟初始化减少启动时间
- 缓存机制提高响应速度
- 多线程支持提高同步效率

## 兼容性

### 向后兼容
- 保留所有原有 API 接口
- 配置格式支持旧版本
- 功能行为保持一致

### 迁移说明
- 现有配置无需修改
- 新功能可逐步启用
- 平滑升级路径

## 测试验证

### 语法检查
- ✅ 主文件 `__init__.py`
- ✅ 核心模块 `core/*.py`
- ✅ 同步操作 `sync_operations.py`

### 功能验证
- 配置解析正确
- 事件注册成功
- 模块间通信正常

## 总结

本次重构成功解决了原有的架构问题：
1. **模块化**: 将大文件拆分为多个专职模块
2. **多路径支持**: 修复了同步路径逻辑，支持多组路径配置
3. **可维护性**: 提高了代码的可读性和维护性
4. **扩展性**: 为后续功能扩展奠定了良好基础

参考 p115strmhelper 的成功经验，transfersync 现在具备了更好的架构设计和更强的功能支持。