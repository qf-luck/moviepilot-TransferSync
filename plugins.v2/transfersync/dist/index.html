<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>整理后同步插件</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
    }

    .card-header {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-header h3 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 500;
    }

    .card-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }

    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      box-sizing: border-box;
    }

    .form-control:focus {
      outline: none;
      border-color: #4facfe;
      box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
    }

    .form-control:hover {
      border-color: #b0bec5;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-items: end;
    }

    .form-row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      box-sizing: border-box;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(79, 172, 254, 0.4);
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #666;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(17, 153, 142, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
      color: white;
    }

    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(255, 107, 107, 0.4);
    }

    .switch-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .path-list {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-top: 10px;
    }

    .path-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin: 8px 0;
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .path-text {
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      color: #333;
      flex: 1;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .status-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
      text-align: center;
    }

    .status-value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .status-label {
      color: #666;
      font-size: 14px;
    }

    .alert {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      color: #1565c0;
    }

    .alert-success {
      background: #e8f5e8;
      border-left: 4px solid #4caf50;
      color: #2e7d32;
    }

    .alert-warning {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
      color: #f57c00;
    }

    .alert-danger {
      background: #ffebee;
      border-left: 4px solid #f44336;
      color: #c62828;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4facfe;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .icon {
      font-size: 18px;
    }

    @media (max-width: 768px) {
      .form-row, .form-row-3 {
        grid-template-columns: 1fr;
      }

      .container {
        padding: 10px;
      }

      .card-body {
        padding: 16px;
      }
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="container">
      <!-- 标题卡片 -->
      <div class="card">
        <div class="card-header">
          <i class="mdi mdi-sync icon"></i>
          <h3>整理后同步插件</h3>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <i class="mdi mdi-information"></i>
            <div>
              <strong>功能说明：</strong>监听多种事件类型自动同步文件到指定位置，支持多种同步策略，默认启用增量同步，简化配置更易使用。
            </div>
          </div>
        </div>
      </div>

      <!-- 基础设置 -->
      <div class="card">
        <div class="card-header">
          <i class="mdi mdi-cog icon"></i>
          <h3>基础设置</h3>
        </div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group">
              <label>
                <div class="switch-container">
                  <div class="switch">
                    <input type="checkbox" id="enabled" v-model="config.enabled">
                    <span class="slider"></span>
                  </div>
                  <span>启用插件</span>
                </div>
              </label>
            </div>
            <div class="form-group">
              <label>
                <div class="switch-container">
                  <div class="switch">
                    <input type="checkbox" id="enable_notifications" v-model="config.enable_notifications">
                    <span class="slider"></span>
                  </div>
                  <span>启用通知</span>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- 同步路径配置 -->
      <div class="card">
        <div class="card-header">
          <i class="mdi mdi-folder-sync icon"></i>
          <h3>同步路径配置</h3>
        </div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group">
              <label for="source_path">源路径</label>
              <input type="text" id="source_path" class="form-control"
                     v-model="config.source_path"
                     placeholder="请输入或选择源路径">
            </div>
            <div class="form-group">
              <label for="target_path">目标路径</label>
              <input type="text" id="target_path" class="form-control"
                     v-model="config.target_path"
                     placeholder="请输入或选择目标路径">
            </div>
          </div>
          <div class="form-group">
            <button class="btn btn-primary" @click="addSyncPath">
              <i class="mdi mdi-plus"></i>
              添加路径
            </button>
          </div>
          <div class="form-group">
            <label for="sync_paths">同步路径列表</label>
            <div class="path-list" v-if="syncPathsList.length > 0">
              <div class="path-item" v-for="(path, index) in syncPathsList" :key="index">
                <span class="path-text">{{ path }}</span>
                <button class="btn btn-danger btn-sm" @click="removeSyncPath(index)">
                  <i class="mdi mdi-delete"></i>
                </button>
              </div>
            </div>
            <div v-else class="alert alert-warning">
              <i class="mdi mdi-alert"></i>
              <span>尚未配置同步路径</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 同步策略配置 -->
      <div class="card">
        <div class="card-header">
          <i class="mdi mdi-cog-sync icon"></i>
          <h3>同步策略配置</h3>
        </div>
        <div class="card-body">
          <div class="form-row-3">
            <div class="form-group">
              <label for="sync_type">同步类型</label>
              <select id="sync_type" class="form-control" v-model="config.sync_type">
                <option value="incremental">增量同步</option>
                <option value="full">全量同步</option>
              </select>
            </div>
            <div class="form-group">
              <label for="execution_mode">执行模式</label>
              <select id="execution_mode" class="form-control" v-model="config.execution_mode">
                <option value="immediate">立即执行</option>
                <option value="delayed">延迟执行</option>
              </select>
            </div>
            <div class="form-group">
              <label for="delay_minutes">延迟时间（分钟）</label>
              <input type="number" id="delay_minutes" class="form-control"
                     v-model="config.delay_minutes"
                     :disabled="config.execution_mode !== 'delayed'"
                     placeholder="5">
            </div>
          </div>
          <div class="form-row-3">
            <div class="form-group">
              <label for="sync_strategy">文件操作</label>
              <select id="sync_strategy" class="form-control" v-model="config.sync_strategy">
                <option value="copy">复制文件</option>
                <option value="move">移动文件</option>
                <option value="softlink">软链接</option>
                <option value="hardlink">硬链接</option>
              </select>
            </div>
            <div class="form-group">
              <label for="max_workers">并发线程数</label>
              <input type="number" id="max_workers" class="form-control"
                     v-model="config.max_workers"
                     placeholder="4">
            </div>
            <div class="form-group">
              <label for="max_depth">最大目录深度</label>
              <input type="number" id="max_depth" class="form-control"
                     v-model="config.max_depth"
                     placeholder="-1（无限制）">
            </div>
          </div>
        </div>
      </div>

      <!-- 触发事件配置 -->
      <div class="card">
        <div class="card-header">
          <i class="mdi mdi-lightning-bolt icon"></i>
          <h3>触发事件配置</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>选择触发事件</label>
            <div class="form-group">
              <label><input type="checkbox" value="transfer.complete" v-model="config.trigger_events"> 整理完成</label>
            </div>
            <div class="form-group">
              <label><input type="checkbox" value="download.added" v-model="config.trigger_events"> 下载添加</label>
            </div>
            <div class="form-group">
              <label><input type="checkbox" value="subscribe.complete" v-model="config.trigger_events"> 订阅完成</label>
            </div>
            <div class="form-group">
              <label><input type="checkbox" value="media.added" v-model="config.trigger_events"> 媒体添加</label>
            </div>
            <div class="form-group">
              <label><input type="checkbox" value="file.moved" v-model="config.trigger_events"> 文件移动</label>
            </div>
          </div>
        </div>
      </div>

      <!-- 文件过滤设置 -->
      <div class="card">
        <div class="card-header">
          <i class="mdi mdi-filter icon"></i>
          <h3>文件过滤设置</h3>
        </div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group">
              <label for="file_filters">文件类型过滤</label>
              <input type="text" id="file_filters" class="form-control"
                     v-model="config.file_filters"
                     placeholder="mp4,mkv,avi,mov">
              <small class="form-text text-muted">只同步指定类型的文件，用逗号分隔</small>
            </div>
            <div class="form-group">
              <label for="exclude_patterns">排除模式</label>
              <input type="text" id="exclude_patterns" class="form-control"
                     v-model="config.exclude_patterns"
                     placeholder="temp,cache,@eaDir">
              <small class="form-text text-muted">排除包含这些字符的文件/目录</small>
            </div>
          </div>
        </div>
      </div>

      <!-- 状态监控 -->
      <div class="card">
        <div class="card-header">
          <i class="mdi mdi-chart-line icon"></i>
          <h3>状态监控</h3>
        </div>
        <div class="card-body">
          <div class="status-grid">
            <div class="status-card">
              <div class="status-value" :class="{'text-success': status.enabled, 'text-danger': !status.enabled}">
                {{ status.enabled ? '已启用' : '已禁用' }}
              </div>
              <div class="status-label">插件状态</div>
            </div>
            <div class="status-card">
              <div class="status-value">{{ status.sync_paths_count || 0 }}</div>
              <div class="status-label">同步路径数量</div>
            </div>
            <div class="status-card">
              <div class="status-value">{{ status.sync_strategy || '--' }}</div>
              <div class="status-label">当前同步策略</div>
            </div>
            <div class="status-card">
              <div class="status-value">{{ status.sync_type || '--' }}</div>
              <div class="status-label">同步类型</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 操作按钮 -->
      <div class="card">
        <div class="card-header">
          <i class="mdi mdi-play icon"></i>
          <h3>操作控制</h3>
        </div>
        <div class="card-body">
          <div class="action-buttons">
            <button class="btn btn-primary" @click="manualSync" :disabled="loading">
              <i class="mdi mdi-sync" :class="{'loading': loading}"></i>
              手动同步
            </button>
            <button class="btn btn-success" @click="incrementalSync" :disabled="loading">
              <i class="mdi mdi-update" :class="{'loading': loading}"></i>
              增量同步
            </button>
            <button class="btn btn-secondary" @click="testPaths">
              <i class="mdi mdi-test-tube"></i>
              测试路径
            </button>
            <button class="btn btn-secondary" @click="getSyncStatus">
              <i class="mdi mdi-information"></i>
              获取状态
            </button>
            <button class="btn btn-primary" @click="saveConfig" :disabled="saving">
              <i class="mdi mdi-content-save" :class="{'loading': saving}"></i>
              保存配置
            </button>
          </div>
        </div>
      </div>

      <!-- 消息提示区域 -->
      <div v-if="message.show" class="alert" :class="'alert-' + message.type">
        <i class="mdi" :class="message.icon"></i>
        <span>{{ message.text }}</span>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
      setup() {
        const config = ref({
          enabled: false,
          source_path: '',
          target_path: '',
          sync_paths: '',
          sync_type: 'incremental',
          execution_mode: 'immediate',
          delay_minutes: 5,
          enable_notifications: false,
          sync_strategy: 'copy',
          max_depth: -1,
          file_filters: '',
          exclude_patterns: '',
          max_workers: 4,
          trigger_events: ['transfer.complete']
        });

        const status = ref({
          enabled: false,
          sync_paths_count: 0,
          sync_strategy: '',
          sync_type: ''
        });

        const message = ref({
          show: false,
          type: 'info',
          text: '',
          icon: 'mdi-information'
        });

        const loading = ref(false);
        const saving = ref(false);

        const syncPathsList = computed(() => {
          if (!config.value.sync_paths) return [];
          return config.value.sync_paths.split('\n').filter(path => path.trim());
        });

        const showMessage = (type, text) => {
          const iconMap = {
            success: 'mdi-check-circle',
            error: 'mdi-alert-circle',
            warning: 'mdi-alert',
            info: 'mdi-information'
          };
          message.value = {
            show: true,
            type: type,
            text: text,
            icon: iconMap[type] || 'mdi-information'
          };
          setTimeout(() => {
            message.value.show = false;
          }, 5000);
        };

        const apiCall = async (url, method = 'GET', data = null) => {
          try {
            const options = {
              method: method,
              headers: {
                'Content-Type': 'application/json',
              }
            };
            if (data) {
              options.body = JSON.stringify(data);
            }
            const response = await fetch(`/api/v1/plugin/TransferSync${url}`, options);
            return await response.json();
          } catch (error) {
            console.error('API调用失败:', error);
            showMessage('error', '网络请求失败: ' + error.message);
            return null;
          }
        };

        const loadConfig = async () => {
          const result = await apiCall('/get_config_api');
          if (result && result.success) {
            Object.assign(config.value, result.data);
          }
        };

        const saveConfig = async () => {
          saving.value = true;
          try {
            const result = await apiCall('/save_config_api', 'POST', config.value);
            if (result && result.success) {
              showMessage('success', '配置保存成功');
            } else {
              showMessage('error', result?.error || '配置保存失败');
            }
          } finally {
            saving.value = false;
          }
        };

        const getSyncStatus = async () => {
          const result = await apiCall('/sync_status');
          if (result && !result.error) {
            status.value = result;
            showMessage('success', '状态获取成功');
          } else {
            showMessage('error', result?.error || '状态获取失败');
          }
        };

        const manualSync = async () => {
          loading.value = true;
          try {
            const result = await apiCall('/manual_sync', 'POST');
            if (result && result.success) {
              showMessage('success', result.message || '手动同步完成');
            } else {
              showMessage('error', result?.error || '手动同步失败');
            }
          } finally {
            loading.value = false;
          }
        };

        const incrementalSync = async () => {
          loading.value = true;
          try {
            const result = await apiCall('/incremental_sync', 'POST');
            if (result && result.success) {
              showMessage('success', result.message || '增量同步完成');
            } else {
              showMessage('error', result?.error || '增量同步失败');
            }
          } finally {
            loading.value = false;
          }
        };

        const testPaths = async () => {
          const result = await apiCall('/test_paths');
          if (result && result.success) {
            showMessage('success', `路径测试完成，共测试${result.results.length}个路径`);
            console.log('路径测试结果:', result.results);
          } else {
            showMessage('error', result?.error || '路径测试失败');
          }
        };

        const addSyncPath = () => {
          if (!config.value.source_path || !config.value.target_path) {
            showMessage('warning', '请先输入源路径和目标路径');
            return;
          }
          const newPath = `${config.value.source_path}->${config.value.target_path}`;
          if (config.value.sync_paths) {
            config.value.sync_paths += '\n' + newPath;
          } else {
            config.value.sync_paths = newPath;
          }
          config.value.source_path = '';
          config.value.target_path = '';
          showMessage('success', '路径添加成功');
        };

        const removeSyncPath = (index) => {
          const paths = syncPathsList.value;
          paths.splice(index, 1);
          config.value.sync_paths = paths.join('\n');
          showMessage('success', '路径删除成功');
        };

        onMounted(() => {
          loadConfig();
          getSyncStatus();
        });

        return {
          config,
          status,
          message,
          loading,
          saving,
          syncPathsList,
          saveConfig,
          getSyncStatus,
          manualSync,
          incrementalSync,
          testPaths,
          addSyncPath,
          removeSyncPath
        };
      }
    }).mount('#app');
  </script>
</body>
</html>