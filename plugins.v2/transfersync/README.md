# 整理后同步插件 V1.3

MoviePilot V2 版本的企业级同步插件，监听可选择的多种事件类型并智能同步到指定位置。

## 🚀 V1.3 代码优化升级

### 核心优化
- **🛡️ 统一事件处理** - 使用装饰器模式统一所有事件处理逻辑，提升代码一致性
- **💾 原子文件操作** - 实现事务性文件操作，支持失败时自动回滚
- **✅ 全面配置验证** - 新增ConfigValidator类，启动时验证所有配置项
- **🔄 增强错误恢复** - 改进异常处理体系，支持自动重试和错误隔离
- **📊 性能监控告警** - 添加事件处理时间监控，识别性能瓶颈
- **🎨 改进UI交互** - 增强配置界面，实时显示验证状态和详细指导

### 技术改进
- **事件装饰器系统** - @event_handler装饰器统一错误处理和性能统计
- **AtomicFileOperation** - 原子文件操作类，确保操作完整性
- **ConfigValidator** - 全面的配置验证器，支持路径、表达式、数值范围验证
- **异常体系升级** - 新增SyncException、SyncPermissionError等专门异常类
- **缓存优化** - TTLCache缓存磁盘空间检查，减少IO开销
- **线程安全** - 使用RLock保护关键资源，避免并发问题

## 🎯 V1.2 事件监听升级

### 新增功能
- **🎯 可选择事件类型** - 支持8种不同的触发事件类型，不再仅限于整理完成事件
- **🔍 事件过滤条件** - 支持复杂的事件过滤条件配置，按需触发同步
- **📊 事件统计监控** - 实时统计各事件类型的触发次数、成功率等指标
- **🔄 多事件并行监听** - 同时监听多个事件类型，提高响应灵活性
- **📈 可视化事件统计** - 详情页展示完整的事件统计数据表格
- **⚡ 代码结构优化** - 重构事件处理机制，提升性能和稳定性

### 支持的事件类型
- **整理完成事件** - 传统的文件整理完成后触发
- **下载添加事件** - 新下载任务添加时触发  
- **订阅完成事件** - 订阅任务完成时触发
- **媒体添加事件** - 媒体库添加新媒体时触发
- **文件移动事件** - 文件移动操作完成时触发
- **目录扫描完成事件** - 目录扫描任务完成时触发
- **刮削完成事件** - 媒体刮削任务完成时触发
- **插件触发事件** - 其他插件主动触发时执行

## 🎯 V1.1 重大更新

### 新增功能
- **🔄 多种同步策略** - 支持复制、移动、硬链接、软链接四种策略
- **🎛️ 多种同步模式** - 立即同步、批量同步、队列同步三种执行模式
- **🔍 智能文件过滤** - 支持文件大小、扩展名、正则表达式过滤
- **📊 实时进度跟踪** - 可视化显示同步进度和统计信息
- **⚡ 性能优化** - 多线程并发处理，支持批量和队列模式
- **✅ 配置验证** - 启动时自动验证配置，提供详细错误提示

### 界面优化
- **📈 进度可视化** - 实时显示同步进度条和速度
- **📋 同步记录** - 展示最近同步历史和详细信息
- **🎨 高级配置** - 分组显示配置项，提升用户体验

## 功能特性

### 核心功能
- **🔄 自动同步** - 监听`TransferComplete`事件，整理完成后立即同步
- **📁 多目标同步** - 支持同时同步到多个目标位置
- **⏰ 定时任务** - 支持增量同步和全量同步的定时执行
- **🔔 消息通知** - 同步完成后可发送通知到指定渠道

### 同步策略
- **复制模式** - 保留原文件，复制到目标位置（默认）
- **移动模式** - 将文件移动到目标位置
- **硬链接** - 创建硬链接，节省存储空间
- **软链接** - 创建软链接，灵活的文件引用

### 同步模式
- **立即同步** - 文件逐个立即处理（默认）
- **批量同步** - 多线程并发批量处理，提升效率
- **队列同步** - 后台队列异步处理，不阻塞主进程

### 文件过滤
- **大小过滤** - 设置最小/最大文件大小限制
- **类型过滤** - 按文件扩展名过滤
- **排除规则** - 使用正则表达式排除特定文件
- **目录深度** - 限制同步的目录层级深度

### 高级特性
- **💾 智能缓存** - 使用MoviePilot V2统一缓存系统
- **🔗 服务集成** - 集成V2版本的服务封装类
- **📊 工作流支持** - 提供工作流动作，可集成到自动化流程
- **📈 详细统计** - 显示同步文件数量、总大小、成功率
- **🛡️ 错误处理** - 完善的异常处理和错误恢复
- **⚙️ 公共服务** - 注册为公共定时服务，便于系统管理

## 配置选项

### 基础设置
- **启用插件** - 控制插件总开关
- **同步目标路径** - 指定要同步到的目标目录，支持多个路径

### 定时任务
- **增量同步** - 定时同步新增或修改的文件
  - 支持Cron表达式配置（默认每6小时执行）
  - 基于文件修改时间判断是否需要同步
- **全量同步** - 定时同步所有整理后的文件  
  - 支持Cron表达式配置（默认每周日凌晨2点执行）
  - 同步所有媒体库中的内容

### 通知设置
- **启用通知推送** - 同步完成后发送消息通知
- **通知渠道** - 指定发送通知的渠道，支持多个渠道

### 高级配置
- **同步策略** - 选择复制、移动、硬链接或软链接
- **同步模式** - 选择立即、批量或队列模式
- **最大目录深度** - 限制递归同步的目录层级（-1表示无限制）
- **最大工作线程** - 并发同步的线程数（默认4个）
- **批次大小** - 批量处理的文件数量（默认100个）

### 触发事件配置 ⭐
- **触发事件类型** - 选择要监听的事件类型，支持多选
  - 整理完成事件：传统的文件整理完成后触发
  - 下载添加事件：新下载任务添加时触发
  - 订阅完成事件：订阅任务完成时触发
  - 媒体添加事件：媒体库添加新媒体时触发
  - 文件移动事件：文件移动操作完成时触发
  - 目录扫描完成事件：目录扫描任务完成时触发
  - 刮削完成事件：媒体刮削任务完成时触发
  - 插件触发事件：其他插件主动触发时执行
- **事件过滤条件** - 设置事件过滤条件，支持复杂条件匹配
  - 格式：属性名=条件值，每行一个条件
  - 支持的条件属性：media_type, quality, size_mb, path, name等
  - 支持的比较操作：>=, <=, >, <, !=, 包含匹配
  - 示例：media_type=movie, quality=>=1080p, size_mb=>=100

### 文件过滤
- **最小文件大小** - 仅同步大于此大小的文件（MB）
- **最大文件大小** - 仅同步小于此大小的文件（MB）
- **文件类型过滤** - 仅同步指定扩展名的文件（如：.mp4,.mkv,.avi）
- **排除模式** - 使用正则表达式排除不需要同步的文件
- **启用进度跟踪** - 显示同步进度信息

## 使用方法

### 基本使用
1. 在插件市场安装并启用插件
2. 配置同步目标路径
3. 选择合适的同步策略和模式
4. 设置文件过滤规则（可选）
5. 启用所需的同步功能
6. 插件将自动监听整理事件并执行同步

### 高级功能

#### 远程命令
- 使用 `/transfersync` 命令触发立即同步

#### API接口
- `GET /sync_now` - 立即执行全量同步

#### 工作流集成
插件提供以下工作流动作：
- **同步单个文件/目录** - 同步指定的文件或目录
- **执行增量同步** - 执行增量同步任务
- **执行全量同步** - 执行全量同步任务

### 系统服务
插件会自动注册以下公共定时服务：
- **整理后同步-增量同步** - 定时增量同步服务
- **整理后同步-全量同步** - 定时全量同步服务

可在"设定-服务"页面查看运行状态和手动启动。

### 状态监控
- **实时进度** - 在详情页面查看当前同步任务进度
- **历史记录** - 查看最近的同步记录和统计信息
- **事件统计监控** ⭐ - 查看各事件类型的触发统计
  - 总触发次数、成功次数、失败次数
  - 成功率百分比显示
  - 最后触发时间、最后成功时间、最后失败时间
  - 支持重置统计数据功能
- **错误日志** - 查看同步过程中的错误和警告信息

## 性能优化建议

### 同步策略选择
- **大量小文件** - 推荐使用硬链接，节省空间和时间
- **跨磁盘同步** - 推荐使用复制模式
- **临时备份** - 推荐使用软链接
- **归档整理** - 推荐使用移动模式

### 同步模式选择
- **少量大文件** - 使用立即模式
- **大量文件** - 使用批量模式提升效率
- **后台处理** - 使用队列模式避免阻塞

### 性能调优
- **并发线程数** - 根据系统性能调整（CPU核心数 × 2）
- **批次大小** - 大文件减少批次大小，小文件增加批次大小
- **文件过滤** - 合理设置过滤规则，减少不必要的处理

## 技术特点

### V2版本特性
- 使用V2版本的服务封装类（NotificationHelper、MediaServerHelper）
- 集成统一缓存系统，支持Redis和内存缓存
- 支持工作流集成，可作为工作流组件使用
- 注册公共定时服务，便于系统管理

### 代码质量
- **类型安全** - 使用枚举类型和类型注解
- **错误处理** - 完善的异常捕获和错误恢复
- **性能优化** - 多线程并发和缓存机制
- **代码规范** - 遵循Python PEP 8编码规范

### 安全特性
- **路径验证** - 验证同步路径的有效性和权限
- **配置校验** - 启动时自动验证所有配置项
- **错误隔离** - 单个文件失败不影响整体同步
- **资源清理** - 插件停止时正确清理所有资源

## 注意事项

1. **权限要求** - 需要认证用户权限（level: 2）
2. **路径配置** - 确保目标路径具有写入权限
3. **存储空间** - 注意目标位置的存储空间充足
4. **网络资源** - 大量文件同步可能消耗网络和I/O资源
5. **硬链接限制** - 硬链接仅支持同一文件系统内的文件
6. **软链接兼容性** - Windows系统的软链接可能需要管理员权限

## 故障排除

### 常见问题
1. **同步失败** - 检查目标路径权限和磁盘空间
2. **进度不更新** - 确保启用了进度跟踪功能
3. **配置错误** - 查看日志中的配置验证错误提示
4. **性能问题** - 适当调整线程数和批次大小

### 日志位置
- 插件日志会记录在MoviePilot的主日志中
- 使用关键词"TransferSync"或"整理后同步"搜索相关日志

## 版本历史

- **v1.3** - 代码优化升级 🚀
  - 统一事件处理机制，使用装饰器模式提升代码一致性
  - 实现原子文件操作，支持失败时自动回滚
  - 新增全面配置验证系统，启动时验证所有配置项
  - 增强错误恢复机制，支持自动重试和错误隔离
  - 添加性能监控告警，识别处理瓶颈
  - 改进UI交互体验，实时显示配置验证状态
  - 优化异常处理体系和线程安全机制
  - 完善缓存系统，减少IO开销

- **v1.2** - 事件监听升级 ⭐
  - 支持可选择的多种触发事件类型（8种事件类型）
  - 添加事件过滤条件配置功能
  - 实现事件统计监控和可视化显示
  - 添加多事件并行监听机制
  - 新增事件统计数据重置功能
  - 优化代码结构和事件处理性能
  - 完善API接口和用户体验

- **v1.1** - 重大更新
  - 添加多种同步策略（复制/移动/硬链接/软链接）
  - 实现多种同步模式（立即/批量/队列）
  - 新增智能文件过滤功能
  - 添加实时进度跟踪和可视化界面
  - 优化性能和内存使用
  - 完善配置验证和错误处理

- **v1.0** - 初始版本
  - 支持整理后自动同步
  - 增量同步和全量同步功能
  - 消息通知支持
  - 工作流集成
  - 缓存系统优化
  - 公共服务注册

## 技术支持

如有问题或建议，请在MoviePilot插件市场或相关技术社区反馈。